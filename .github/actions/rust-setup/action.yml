name: "Rust Setup"
description: "Sets up Rust with sccache and caching"

runs:
  using: "composite"
  steps:
    - name: Configure runtime env
      shell: bash
      run: |
        echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV  
        echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV 
        echo "RUST_BACKTRACE=1" >> $GITHUB_ENV
        echo "RUSTFLAGS=-C debuginfo=line-tables-only -C incremental=false" >> $GITHUB_ENV

    - name: Cache
      uses: actions/cache@v3
      with:
        path: |
          /usr/local/cargo/bin/
          /usr/local/cargo/registry/index/
          /usr/local/cargo/registry/cache/
          /usr/local/cargo/git/db/
          /usr/local/cache/sccache/
          /usr/local/rustup/
          /usr/local/target/
        key: cargo-cache3-${{ hashFiles('**/Cargo.toml') }}
        restore-keys: cargo-cache3-
 
    - name: Setup sccache
      uses: mozilla-actions/sccache-action@v0.0.7

    - name: Generate lockfile
      shell: bash
      run: cargo fetch

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        components: rustfmt, clippy, rust-src
        toolchain: nightly-2025-01-24

    - name: Show initial sccache stats
      shell: bash
      run: sccache --show-stats
