name: Rust CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    name: Basic check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        # Unfortunately, the fastlanes need to use nightly rustc.
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy, rust-src

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Check documentation
        run: cargo doc --no-deps --document-private-items --all-features
        env:
          RUSTDOCFLAGS: -D warnings

      - name: Run clippy
        run: cargo clippy -- -D warnings

  unit_test:
    name: Unit Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy, rust-src

      - name: Run tests
        run: cargo test --verbose

  address_san:
    name: Address Sanitizer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy, rust-src

      - name: Run address sanitizer
        run: >
          env RUSTFLAGS="-Z sanitizer=address" cargo test -Zbuild-std --target x86_64-unknown-linux-gnu --tests

  memory_san:
    name: Memory Sanitizer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy, rust-src

      - name: Run memory sanitizer
        run: >
          env RUSTFLAGS="-Z sanitizer=memory" cargo test -Zbuild-std --target x86_64-unknown-linux-gnu --tests

  integration_test:
    name: Integration Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy, rust-src

      - name: Build LiquidCache server
        run: cargo build --release --bin bench_server

      - name: Start LiquidCache server
        run: env RUST_LOG=info nohup cargo run --release --bin bench_server &> server.log &

      - name: Run simple ClickBench
        run: |
          env RUST_LOG=info cargo run --release --bin bench_client -- --query-path benchmark/queries.sql --file examples/small_hits.parquet

      - name: Kill LiquidCache server
        run: pkill bench_server || true

      - name: Download ClickBench partition 0
        run: |
          wget https://datasets.clickhouse.com/hits_compatible/athena_partitioned/hits_0.parquet -O benchmark/data/hits_0.parquet

      - name: Start LiquidCache server (for partition 0)
        run: env RUST_LOG=info nohup cargo run --release --bin bench_server &> server.log &

      - name: Run ClickBench partition 0
        run: |
          env RUST_LOG=info cargo run --release --bin bench_client -- --query-path benchmark/queries.sql --file benchmark/data/hits_0.parquet

      - name: Display server logs (on failure)
        if: failure()
        run: cat server.log
